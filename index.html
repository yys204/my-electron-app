<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„ç¬”è®°æœ¬</title>
  <!-- å¼•å…¥ Markdown åº“ -->
  <script src="./libs/marked.min.js"></script> 
  <!-- å¦‚æœä½ è¿˜æ²¡æœ‰æœ¬åœ°æ–‡ä»¶ï¼Œæš‚æ—¶ç”¨ CDN æµ‹è¯• -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> -->

  <style>
    /* --- 1. å…¨å±€ä¸ä¹¦ç±é£æ ¼è®¾å®š --- */
    :root {
      --bg-color: #fcf6e5; /* æš–è‰²çº¸å¼ èƒŒæ™¯ */
      --text-color: #2b2b2b; /* æ·±ç°å¢¨æ°´è‰² */
      --accent-color: #8b4513; /* æ£•è‰²ç‚¹ç¼€ */
      --highlight-color: #ffeb3b; /* è§å…‰ç¬”é«˜äº® */
      --header-height: 40px;
    }

    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      font-family: "Georgia", "Times New Roman", serif; /* å…³é”®ï¼šè¡¬çº¿å­—ä½“ */
      background-color: transparent; /* é€æ˜èƒŒæ™¯ */
      display: flex;
      flex-direction: column;
    }

    /* æ¨¡æ‹Ÿä¹¦æœ¬çš„å®¹å™¨ */
    .book-container {
      flex: 1;
      display: flex;
      background: var(--bg-color);
      margin: 10px; /* ç•™å‡ºä¸€ç‚¹è¾¹è·çœ‹èƒŒæ™¯ */
      border-radius: 5px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* ç«‹ä½“æŠ•å½± */
      position: relative;
      overflow: hidden;
    }

    /* --- 2. é¡¶éƒ¨å·¥å…·æ  (Header) --- */
    .header {
      height: var(--header-height);
      background: transparent; /* é€æ˜ï¼Œèå…¥ä¹¦æœ¬ */
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 100;
    }

    /* æ‹–æ‹½åŒºåŸŸ */
    .drag-region {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      -webkit-app-region: drag;
      z-index: -1; /* åœ¨æŒ‰é’®ä¸‹é¢ */
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-box {
      display: flex;
      align-items: center;
      background: rgba(0,0,0,0.05);
      border-radius: 15px;
      padding: 2px 10px;
      transition: all 0.3s;
      -webkit-app-region: no-drag; /* è¾“å…¥æ¡†ä¸èƒ½æ‹–æ‹½ */
    }
    .search-box:focus-within {
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .search-input {
      border: none;
      background: transparent;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      width: 120px;
      color: var(--accent-color);
    }
    .search-count {
      font-size: 12px;
      color: #999;
      margin-left: 5px;
    }

    /* å…³é—­æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .btn-close {
      font-family: sans-serif;
      cursor: pointer;
      color: #999;
      font-size: 20px;
      padding: 0 8px;
      -webkit-app-region: no-drag;
      transition: color 0.2s;
    }
    .btn-close:hover { color: #d9534f; }

    /* --- 3. ç¼–è¾‘åŒºä¸é¢„è§ˆåŒº (Split Layout) --- */
    .content-wrapper {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: var(--header-height); /* é¿å¼€å¤´éƒ¨ */
    }

    #editor, #preview {
      flex: 1;
      height: 100%;
      box-sizing: border-box;
      padding: 20px 30px;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.8; /* å®½æ¾çš„è¡Œé«˜ï¼Œæ›´åƒä¹¦ */
      color: var(--text-color);
    }

    /* å·¦ä¾§ç¼–è¾‘åŒº */
    #editor {
      border: none;
      outline: none;
      background: transparent;
      resize: none;
      /* æ¨¡æ‹Ÿå·¦é¡µçº¸å¼  */
    }

    /* å³ä¾§é¢„è§ˆåŒº */
    #preview {
      /* æ¨¡æ‹Ÿå³é¡µçº¸å¼  */
    }
    
    /* ä¸­ç¼é˜´å½±ï¼šå…³é”®è§†è§‰å…ƒç´  */
    .spine {
      width: 1px;
      background: rgba(0,0,0,0.1);
      box-shadow: 0 0 30px 10px rgba(0,0,0,0.08) inset; /* å†…é˜´å½±æ¨¡æ‹Ÿä¹¦è„Š */
      z-index: 10;
    }

    /* --- 4. Markdown ç»†èŠ‚ä¼˜åŒ– --- */
    #preview h1, #preview h2 {
      color: var(--accent-color);
      border-bottom: 1px dashed rgba(139, 69, 19, 0.3);
      padding-bottom: 5px;
    }
    #preview blockquote {
      border-left: 4px solid var(--accent-color);
      margin: 0;
      padding-left: 15px;
      color: #666;
      background: rgba(0,0,0,0.03);
    }
    
    /* æœç´¢é«˜äº®æ ·å¼ */
    mark {
      background: var(--highlight-color);
      border-radius: 2px;
      color: #000;
      padding: 0 2px;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>

  <!-- ä¹¦æœ¬å¤–å£³ -->
  <div class="book-container">
    
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="header">
      <div class="drag-region"></div>
      
      <!-- æœç´¢åŠŸèƒ½åŒº -->
      <div class="search-box">
        <span style="font-size:12px; opacity:0.5;">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æŸ¥æ‰¾ç¬”è®°...">
        <span id="search-count" class="search-count"></span>
      </div>

      <!-- çª—å£æ§åˆ¶åŒº -->
      <div class="btn-close" id="btn-close" title="éšè—çª—å£">Ã—</div>
    </div>

    <!-- å†…å®¹åŒº -->
    <div class="content-wrapper">
      <!-- å·¦é¡µï¼šç¼–è¾‘ -->
      <textarea id="editor" placeholder="# ä»Šå¤©çš„éšç¬”..."></textarea>
      
      <!-- ä¹¦è„Šä¸­ç¼ -->
      <div class="spine"></div>
      
      <!-- å³é¡µï¼šé¢„è§ˆ -->
      <div id="preview"></div>
    </div>
  </div>

  <script>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const searchInput = document.getElementById('search-input');
    const searchCount = document.getElementById('search-count');
    
    // ä¿å­˜åŸå§‹å†…å®¹ï¼ˆç”¨äºæœç´¢åè¿˜åŸï¼‰
    let currentMarkdown = "";

    // --- 1. åˆå§‹åŒ– & åŠ è½½ ---
    window.onload = async () => {
      // ä»åç«¯è¯»å–æ–‡ä»¶
      const content = await window.electronAPI.readNote();
      currentMarkdown = content || '';
      editor.value = currentMarkdown;
      renderPreview(currentMarkdown);
    };

    // --- 2. å®æ—¶ç¼–è¾‘ä¸ä¿å­˜ ---
    let timer;
    editor.addEventListener('input', (e) => {
      const text = e.target.value;
      currentMarkdown = text;
      
      // å¦‚æœæ­£åœ¨æœç´¢ï¼Œå…ˆæ¸…ç©ºæœç´¢æ¡†ï¼Œå› ä¸ºå†…å®¹å˜äº†
      if (searchInput.value) {
        searchInput.value = '';
        searchCount.innerText = '';
      }

      renderPreview(text);

      // é˜²æŠ–ä¿å­˜
      clearTimeout(timer);
      timer = setTimeout(() => {
        window.electronAPI.saveNote(text);
      }, 500);
    });

    // --- 3. æ¸²æŸ“é€»è¾‘ ---
    function renderPreview(text) {
      preview.innerHTML = marked.parse(text);
    }

    // --- 4. æœç´¢é«˜äº®é€»è¾‘ ---
    searchInput.addEventListener('input', (e) => {
      const keyword = e.target.value.trim();
      
      // 1. å…ˆé‡ç½®é¢„è§ˆåŒºä¸ºçº¯å‡€ç‰ˆ
      renderPreview(currentMarkdown);
      
      if (!keyword) {
        searchCount.innerText = '';
        return;
      }

      // 2. æ‰§è¡Œæœç´¢å’Œé«˜äº® (åœ¨ Preview é‡Œæœï¼Œå› ä¸ºå®ƒå·²ç»æ¸²æŸ“å¥½äº†)
      highlightAndScroll(keyword);
    });

    function highlightAndScroll(keyword) {
      const content = preview.innerHTML;
      // åˆ›å»ºæ­£åˆ™ï¼Œgi è¡¨ç¤ºå…¨å±€+å¿½ç•¥å¤§å°å†™
      const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
      
      // æ£€æŸ¥åŒ¹é…æ•°é‡
      const matches = content.match(regex);
      if (!matches) {
        searchCount.innerText = '0/0';
        return;
      }
      
      // 3. æ›¿æ¢ HTML å†…å®¹æ·»åŠ  <mark>
      // æ³¨æ„ï¼šè¿™é‡Œç®€å•å¤„ç†ï¼Œå¯èƒ½ä¼šç ´å HTML æ ‡ç­¾å†…çš„å±æ€§ï¼ˆæ¯”å¦‚ hrefé‡Œçš„æ–‡å­—ï¼‰
      // ç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ mark.js åº“ï¼Œä½†è¿™é‡Œæ‰‹å†™æ­£åˆ™å¤Ÿç”¨äº†
      const newHtml = content.replace(regex, '<mark>$1</mark>');
      preview.innerHTML = newHtml;

      // æ›´æ–°è®¡æ•°
      searchCount.innerText = `1/${matches.length}`;

      // 4. æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
      const firstMark = preview.querySelector('mark');
      if (firstMark) {
        firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // è¾…åŠ©ï¼šè½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // --- 5. å…³é—­çª—å£ ---
    document.getElementById('btn-close').addEventListener('click', () => {
      window.electronAPI.hideWindow();
    });

  </script>
</body>
</html>